---
title:  11.- Ampliació - Lògica Negoci
parent: SPRING
has_children: true
layout: default  
nav_order: 120
---



# Lògica de Negoci

Anem a afegir una funcionalitat nova que va més enllà del CRUD: **calcular estadístiques d’una província** a partir de les seues ciutats.

Crearem un nou endpoint:

```
GET /api/provincies/{id}/estadistiques
```

Quan el client el cride, el servidor:

* Buscarà la província indicada per `{id}`.
* Recuperarà totes les ciutats associades a eixa província.
* Calcularà estes estadístiques:

    * `numCiutats` (quantes ciutats té)
    * `poblacioTotal` (suma de població de totes les ciutats)
    * `poblacioMitjana` (mitjana de població)
    * `ciutatMesPoblada` (nom de la ciutat amb més població)
    * `ciutatMenysPoblada` (nom de la ciutat amb menys població)

La resposta serà un JSON amb estos valors calculats.

---

### Necessitat de crear un Service

El `Service` és la capa on fem els càlculs i apliquem les regles. El controlador només gestiona la petició HTTP i el repositori només accedeix a la base de dades.

* El controlador no ha de calcular.
* El repositori no ha de decidir.
* El servei pensa.

---

### Necessitat de crear un DTO

Les estadístiques no existixen com a taula en la base de dades, perquè són dades calculades. Per això no podem retornar directament l’entitat `Provincia`.

Creem un objecte específic:

```
ProvinciaEstadistiquesResponse
```

Este objecte només conté els camps que volem enviar al client, i Spring el convertirà automàticament a JSON.

---

### Com es relacionen els diferents elements

El flux és:

1. El client fa la petició.
2. El controlador la rep.
3. El controlador crida al Service.
4. El Service usa el Repository per obtindre dades.
5. El Service calcula i crea el DTO.
6. El controlador retorna el DTO en format JSON.

---

## Passos

En esta pràctica afegirem tres elements nous al projecte: un **DTO**, un **Service** i un **controlador**.

### 1.- DTO 

Fitxer: 
```
... /model/dto/ProvinciaEstadistiquesResponse.java
```

```java

public class ProvinciaEstadistiquesResponse {

    private int numCiutats;
    private long poblacioTotal;
    private double poblacioMitjana;
    private String ciutatMesPoblada;
    private String ciutatMenysPoblada;

    public ProvinciaEstadistiquesResponse() {
    }

    public ProvinciaEstadistiquesResponse(int numCiutats, long poblacioTotal, double poblacioMitjana, String ciutatMesPoblada, String ciutatMenysPoblada) {    
        
        this.numCiutats = numCiutats;
        this.poblacioTotal = poblacioTotal;
        this.poblacioMitjana = poblacioMitjana;
        this.ciutatMesPoblada = ciutatMesPoblada;
        this.ciutatMenysPoblada = ciutatMenysPoblada;
    }

    public int getNumCiutats() {
        return numCiutats;
    }

    public void setNumCiutats(int numCiutats) {
        this.numCiutats = numCiutats;
    }

    public long getPoblacioTotal() {
        return poblacioTotal;
    }

    public void setPoblacioTotal(long poblacioTotal) {
        this.poblacioTotal = poblacioTotal;
    }

    public double getPoblacioMitjana() {
        return poblacioMitjana;
    }

    public void setPoblacioMitjana(double poblacioMitjana) {
        this.poblacioMitjana = poblacioMitjana;
    }

    public String getCiutatMesPoblada() {
        return ciutatMesPoblada;
    }

    public void setCiutatMesPoblada(String ciutatMesPoblada) {
        this.ciutatMesPoblada = ciutatMesPoblada;
    }

    public String getCiutatMenysPoblada() {
        return ciutatMenysPoblada;
    }

    public void setCiutatMenysPoblada(String ciutatMenysPoblada) {
        this.ciutatMenysPoblada = ciutatMenysPoblada;
    }
}
```

---

### 2.  Service 

Fitxer:

```
... /service/ProvinciaEstadistiquesService.java
```

```java
@Service
public class ProvinciaEstadistiquesService {

    @Autowired
    private ProvinciaRepository provinciaRepository;

    public ProvinciaEstadistiquesResponse obtindreEstadistiques(Long provinciaId) {

        // 1) Buscar la província

        // Si no existeix una província amb eixe id: error 404
        Provincia provincia = provinciaRepository.findById(provinciaId)
                .orElseThrow(() -> new ResponseStatusException( HttpStatus.NOT_FOUND, "Província no trobada"));

        // 2) Recuperar les ciutats
        List<Ciutat> ciutats = provincia.getCiutats();

        // Si la província no té ciutats associades: error 404
        if (ciutats == null || ciutats.isEmpty()) {
            throw new ResponseStatusException(HttpStatus.NOT_FOUND, "La província no té ciutats");
        }

        // 3) Inicialitzar variables
        int numCiutats = ciutats.size();
        long poblacioTotal = 0;

        // Agafa el primer element de la llista
        Ciutat ciutatMesPoblada = ciutats.get(0);
        Ciutat ciutatMenysPoblada = ciutats.get(0);

        // 4) Recorregut i càlcul
        for (Ciutat ciutat : ciutats) {

            long poblacio = ciutat.getPoblacio();
            poblacioTotal += poblacio;

            if (poblacio > ciutatMesPoblada.getPoblacio()) {
                ciutatMesPoblada = ciutat;
            }

            if (poblacio < ciutatMenysPoblada.getPoblacio()) {
                ciutatMenysPoblada = ciutat;
            }
        }

        double poblacioMitjana = (double) poblacioTotal / numCiutats;

        // 5) Retornar el DTO
        return new ProvinciaEstadistiquesResponse(
                numCiutats,
                poblacioTotal,
                poblacioMitjana,
                ciutatMesPoblada.getNom(),
                ciutatMenysPoblada.getNom()
        );
    }
}
```

---

### 3.-Controlador

Fitxer:

```
... controller/ProvinciaEstadistiquesRestController.java
```

```java

@RestController
@RequestMapping("/api/provincies")
public class ProvinciaEstadistiquesRestController {

    @Autowired
    private ProvinciaEstadistiquesService provinciaEstadistiquesService;

    @GetMapping("/{id}/estadistiques")
    public ProvinciaEstadistiquesResponse obtindreEstadistiques(@PathVariable Long id) {
        return provinciaEstadistiquesService.obtindreEstadistiques(id);
    }
}
```

---

### Endpoint
```
GET http://localhost:8082/api/provincies/1/estadistiques
```

Errors previstos:

* Província inexistent: 404 “Província no trobada”
* Província sense ciutats: 404 “La província no té ciutats”

---

