---
title:  12.- AMPLIACIÓ 2 - Gestió d'arxius - UPLOAD
parent: SPRING
has_children: true
layout: default  
nav_order: 130
---


# Upload de Fitxers

Anem a afegir una funcionalitat nova que permet **pujar fitxers al servidor**, guardar-los en una carpeta local i poder **visualitzar-los o eliminar-los** posteriorment.

Crearem tres endpoints principals:

```
GET /upload
POST /upload
GET /uploads/{filename}
POST /upload/delete/{filename}
```

Quan el client utilitze la pàgina d’upload, el servidor:

* Mostrarà el formulari de pujada.
* Guardarà el fitxer en la carpeta `upload-dir`.
* Mostrarà la llista de fitxers existents.
* Permetrà visualitzar-los.
* Permetrà eliminar-los.

La resposta principal serà una **vista HTML (Thymeleaf)** i, en el cas de visualització de fitxers, un **Resource** retornat pel controlador REST.

---

### Necessitat de separar MVC i REST

En esta pràctica utilitzem dos controladors diferents perquè tenen responsabilitats distintes.

El controlador MVC:

* Mostra la vista HTML.
* Gestiona el formulari.
* Redirigix després de pujar o eliminar.

El controlador REST:

* Retorna el fitxer com a `Resource`.
* Controla el `Content-Type`.
* Permet mostrar imatges i PDFs en línia.

Necessitem dos controladors perquè un gestiona la **vista HTML i els formularis (MVC)**, mentre que l’altre s’encarrega de **retornar el fitxer com a recurs HTTP (REST)**.

Així separem responsabilitats: un mostra la pàgina i l’altre serveix el contingut.

---

### Carpeta d’emmagatzematge

Els fitxers pujats no es guarden en la base de dades.

Es guarden en una carpeta del sistema:

```
upload-dir
```

>La crearem a l'arrel del projecte

---

### Relació entre els diferents elements

El flux és:

1. El client entra en `/upload`.
2. El controlador MVC mostra la plantilla.
3. El client envia un fitxer amb `POST /upload`.
4. El controlador guarda el fitxer en `upload-dir`.
5. La vista mostra la llista actualitzada.
6. Si el client fa clic en un fitxer, es crida `GET /uploads/{filename}`.
7. El controlador REST retorna el fitxer.

---

## Passos

Anem a incorporar

* Un controlador REST.
* Un controlador MVC.
* Una plantilla HTML.

---

### 0.- Application.properties

Afegim dos propietats al fitxer `application.properties`, per tal de limitar el tamany dels fitxers pujats:
Pots ajustar el valor segons necessitats.

```bash

# Upload
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=10MB


```


### 1.- Controlador REST

Fitxer:

```
... /controller/UploadController.java
```

```java
package com.jaume.Provincies.controller;

import org.springframework.core.io.Resource;
import org.springframework.core.io.UrlResource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.net.MalformedURLException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

@RestController
public class UploadController {

    private final Path uploadDir = Paths.get("upload-dir");

    @GetMapping("/uploads/{filename:.+}")
    public ResponseEntity<Resource> veure(@PathVariable String filename) {

        try {
            Path filePath = uploadDir.resolve(filename).normalize();

            // Evitem eixir de la carpeta d'uploads
            if (!filePath.startsWith(uploadDir)) {
                return ResponseEntity.badRequest().build();
            }

            Resource resource = new UrlResource(filePath.toUri());

            if (!resource.exists() || !resource.isReadable()) {
                return ResponseEntity.notFound().build();
            }

            String contentType = Files.probeContentType(filePath);
            if (contentType == null) {
                contentType = "application/octet-stream";
            }

            return ResponseEntity.ok()
                    .header(HttpHeaders.CONTENT_DISPOSITION,
                            "inline; filename=\"" + resource.getFilename() + "\"")
                    .contentType(MediaType.parseMediaType(contentType))
                    .body(resource);

        } catch (MalformedURLException e) {
            return ResponseEntity.badRequest().build();
        } catch (Exception e) {
            return ResponseEntity.internalServerError().build();
        }
    }
}
```

---

### Endpoint

```
GET http://localhost:8082/uploads/nomFitxer.ext
```

---

### 2.- Controlador MVC

Fitxer:

```
... /controller/UploadMVCController.java
```

```java
package com.jaume.Provincies.controller;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;

import java.nio.file.*;
import java.util.ArrayList;
import java.util.List;

@Controller
public class UploadMVCController {

    private final Path uploadDir = Paths.get("upload-dir");

    @GetMapping("/upload")
    public String mostrarForm(Model model) {

        List<String> files = new ArrayList<>();

        try {
            Files.createDirectories(uploadDir);

            Files.list(uploadDir).forEach(path -> {
                String nom = path.getFileName().toString();
                files.add(nom);
            });

        } catch (Exception e) {
            // Si falla la lectura, es mostra igualment la pàgina sense llista
        }

        model.addAttribute("files", files);
        return "uploadForm";
    }

    @PostMapping("/upload")
    public String pujar(@RequestParam("file") MultipartFile file,
                        RedirectAttributes redirectAttributes) {

        if (file.isEmpty()) {
            redirectAttributes.addFlashAttribute("message", "Fitxer buit");
            return "redirect:/upload";
        }

        try {
            Files.createDirectories(uploadDir);

            String filename = StringUtils.cleanPath(file.getOriginalFilename());

            if (filename.contains("..")) {
                redirectAttributes.addFlashAttribute("message", "Nom de fitxer no vàlid");
                return "redirect:/upload";
            }

            Path destination = uploadDir.resolve(filename).normalize();
            Files.copy(file.getInputStream(), destination, StandardCopyOption.REPLACE_EXISTING);

            redirectAttributes.addFlashAttribute("message", "Fitxer pujat: " + filename);

        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("message", "Error guardant el fitxer");
        }

        return "redirect:/upload";
    }

    @PostMapping("/upload/delete/{filename:.+}")
    public String eliminar(@PathVariable String filename,
                           RedirectAttributes redirectAttributes) {

        try {
            Path filePath = uploadDir.resolve(filename).normalize();

            // Evitem eixir de la carpeta d'uploads
            if (!filePath.startsWith(uploadDir)) {
                redirectAttributes.addFlashAttribute("message", "Nom de fitxer no vàlid");
                return "redirect:/upload";
            }

            boolean deleted = Files.deleteIfExists(filePath);

            if (deleted) {
                redirectAttributes.addFlashAttribute("message", "Fitxer eliminat: " + filename);
            } else {
                redirectAttributes.addFlashAttribute("message", "El fitxer no existix");
            }

        } catch (Exception e) {
            redirectAttributes.addFlashAttribute("message", "Error eliminant el fitxer");
        }

        return "redirect:/upload";
    }
}
```

---

### Endpoints

```
GET  http://localhost:8082/upload
POST http://localhost:8082/upload
POST http://localhost:8082/upload/delete/{filename}
```


---

### 3.- Plantilla

Fitxer:

```
src/main/resources/templates/uploadForm.html
```

```html
<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Pujada de fitxers</title>
    <link rel="stylesheet" th:href="@{/css/upload.css}">
</head>
<body>

<h2>Pujada de fitxers</h2>

<div th:if="${message}">
    <p th:text="${message}"></p>
</div>

<form method="POST" enctype="multipart/form-data" action="/upload">
    <p>
        <label>Fitxer:</label>
        <input type="file" name="file">
    </p>
    <p>
        <input type="submit" value="Pujar">
    </p>
</form>

<hr>

<h3>Fitxers pujats</h3>

<ul>
    <li th:each="f : ${files}">
        <a th:href="@{'/uploads/' + ${f}}" th:text="${f}"></a>
        <form th:action="@{'/upload/delete/' + ${f}}" method="POST" style="display:inline;">
            <button type="submit">Eliminar</button>
        </form>
    </li>
</ul>

</body>
</html>
```

---

## Proves

### Prova 1 — Entrar a la pàgina

```
GET http://localhost:8082/upload
```

Ha d’aparéixer el formulari i la llista.

---

### Prova 2 — Pujar fitxer

Selecciona un fitxer i prem “Pujar”.

Ha de:

* Mostrar missatge.
* Crear el fitxer en `upload-dir`.
* Afegir-lo a la llista.

---

### Prova 3 — Visualitzar fitxer

Fes clic en el nom.

S’executa:

```
GET /uploads/{filename}
```

Ha de mostrar-se en el navegador si és imatge o PDF.

---

### Prova 4 — Eliminar fitxer

Prem “Eliminar”.

Ha de:

* Mostrar missatge.
* Eliminar-lo de la carpeta.
* Desaparéixer de la llista.

---



---

# Proves en Postman — Upload

### 0) Autorització (obligatòria)

En cada request de Postman:

* **Authorization** → **Type: Basic Auth**
* **Username**: (un usuari existent en la BD de security)
* **Password**: la seua contrasenya

Si no poses Basic Auth:

* Rebràs **401 Unauthorized** o redirecció al login.

---

### 1) Mostrar la pàgina d’upload (HTML)

**Request**

```
GET http://localhost:8082/upload
```

* **200 OK**
* Body: HTML (la plantilla renderitzada)

---

### 2) Pujar un fitxer (multipart/form-data)

**Request**

```
POST http://localhost:8082/upload
```


**Body**

* Body → **form-data**

    * Key: `file`
    * Tipus: **File**
    * Value: selecciona un fitxer (png/jpg/pdf)

**Headers**

* No poses `Content-Type` a mà. Postman el posa bé automàticament.

**Resposta esperada**

* **302 Found** (perquè el controlador fa `redirect:/upload`)
* Header `Location: /upload`

---

### 3) Visualitzar un fitxer pujat

**Request**

```
GET http://localhost:8082/uploads/NOM_DEL_FITXER
```

Exemples:

```
GET http://localhost:8082/uploads/foto.png
GET http://localhost:8082/uploads/document.pdf
```


* **200 OK**
* Body: el fitxer (binari)
* Header `Content-Type` segons el fitxer (imatge/pdf/…)

**Errors**

* **404 Not Found** si no existix el fitxer
* **400 Bad Request** si el nom intenta eixir de la carpeta (`../`)

---

## 4) Eliminar un fitxer

**Request**

```
POST http://localhost:8082/upload/delete/NOM_DEL_FITXER
```

Exemple:

```
POST http://localhost:8082/upload/delete/foto.png
```



### Important sobre “JSON”

En esta fase **no hi ha JSON** perquè:

* La pujada és **multipart/form-data** amb un camp `file`.
* La resposta és **HTML** (vista) o **binari** (Resource del fitxer).

---

